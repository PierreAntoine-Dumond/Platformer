-- Cette ligne permet d'afficher des traces dans la console pendant l'éxécution
io.stdout:setvbuf("no")

-- Empèche Love de filtrer les contours des images quand elles sont redimentionnées
-- Indispensable pour du pixel art
love.graphics.setDefaultFilter("nearest")

-- Cette ligne permet de déboguer pas à pas dans ZeroBraneStudio
if arg[#arg] == "-debug" then
  require("mobdebug").start()
end

-- Chargement des images
local lstSprites = {}

local imgTiles = {}
imgTiles["1"] = love.graphics.newImage("_ressources_/images/tile1.png")
imgTiles["2"] = love.graphics.newImage("_ressources_/images/tile2.png")
imgTiles["3"] = love.graphics.newImage("_ressources_/images/tile3.png")
imgTiles["4"] = love.graphics.newImage("_ressources_/images/tile4.png")
imgTiles["5"] = love.graphics.newImage("_ressources_/images/tile5.png")
imgTiles["6"] = love.graphics.newImage("_ressources_/images/tile[.png")
imgTiles["7"] = love.graphics.newImage("_ressources_/images/tile].png")
imgTiles["8"] = love.graphics.newImage("_ressources_/images/tile#.png")
imgTiles["9"] = love.graphics.newImage("_ressources_/images/tile=.png")
imgTiles["10"] = love.graphics.newImage("_ressources_/images/tileg.png")
imgTiles["11"] = love.graphics.newImage("_ressources_/images/tileH.png")

function ChargeNiveau(pNum)
  map = {}
  if pNum == 1 then
    map[1] = "11111111111111111111111111111111111111111111111111"
    map[2] = "40000000000000000000000000000000000000000000000005"
    map[3] = "40001111111111111111100011111111111111111111100005"
    map[4] = "40000000000000000000000000000000000000000000000005"
    map[5] = "40000000000000000000000000000000000000000000000005"
    map[6] = "40000000000011111111111000000000000000000000000005"
    map[7] = "40000000000000000000000000000000000000000000000005"
    map[8] = "41111111111000000000000000000000000000000011111115"
    map[9] = "40000000000000000000000000000000000000000000000005"
    map[10] = "40000000000000000000000000000000000000000000000005"
    map[11] = "40000000001111000000111100000011110000001111000005"
    map[12] = "40000000000000000000000000000000000000000000000005"
    map[13] = "41111110000000000000000000000000000000000000000005"
    map[14] = "40000000000000000000000000000000000000000000000005"
    map[15] = "40000000001111111100000000000000000000000000000005"
    map[16] = "40000000000000000000000000000000000000000000000005"
    map[17] = "40000000000000000000000000000000000000000000000005"
    map[18] = "40000000000000000000000000000000000000000000000005"
    map[19] = "40000000000000000000000000000000000000000000000005"
    map[20] = "40000000000000000000000000000000000000000000000005"
    map[21] = "40000000000000000000000000000000000000000000000005"
    map[22] = "40000000000011111111111000000000000000000000000005"
    map[23] = "40000000000000000000000000000000000000000000000005"
    map[24] = "41111111111000000000000000000000000000000000000005"
    map[25] = "40000000000000000000000000000000000000000000000005"
    map[26] = "40000000000000000000000000000000000000000000000005"
    map[27] = "40000000000000000000000000000000000000000000000005"
    map[28] = "40001111111111111100000000011111111111111111100005"
    map[29] = "40000000000000000000000000000000000000000000000005"
    map[30] = "40000000000000000000111100000000000000000000000005"
    map[31] = "40000000000000011110000000000000000000000000000005"
    map[32] = "41111111110000000000000000000000000000000000000005"
    map[33] = "40000000000000000000000000000000000000000000000005"
    map[34] = "40000000000000000000000000000000000000000000000005"
    map[35] = "40000000000000000000000000000000000000000000000005"
    map[36] = "40000000000000000000000000000000000000000000000005"
    map[37] = "11111111111111111111111111111111111111111111111111"
  elseif pNum == 2 then
    map[1] = "11111111111111111111111111111111111111111111111111"
    map[2] = "40000000000000000000000000000000000000000000000005"
    map[3] = "40001111111111111111100011111111111111111111100005"
    map[4] = "40000000000000000000000000000000000000000000000005"
    map[5] = "40000000000000000000000000000000000000000000000005"
    map[6] = "40000000000011111111111000000000000000000000000005"
    map[7] = "40000000000000000000000000000000000000000000000005"
    map[8] = "41111111111000000000000000000000000000000011111115"
    map[9] = "40000000000000000000000000000000000000000000000005"
    map[10] = "40000000000000000000000000000000000000000000000005"
    map[11] = "40000000001111000000111100000011110000001111000005"
    map[12] = "40000000000000000000000000000000000000000000000005"
    map[13] = "41111110000000000000000000000000000000000000000005"
    map[14] = "40000000000000000000000000000000000000000000000005"
    map[15] = "40000000001111111100000000000000000000000000000005"
    map[16] = "40000000000000000000000000000000000000000000000005"
    map[17] = "40000000000000000000000000000000000000000000000005"
    map[18] = "40000000000000000000000000000000000000000000000005"
    map[19] = "40000000000000000000000000000000000000000000000005"
    map[20] = "40000000000000000000000000000000000000000000000005"
    map[21] = "40000000000000000000000000000000000000000000000005"
    map[22] = "40000000000011111111111000000000000000000000000005"
    map[23] = "40000000000000000000000000000000000000000000000005"
    map[24] = "41111111111000000000000000000000000000000000000005"
    map[25] = "40000000000000000000000000000000000000000000000005"
    map[26] = "40000000000000000000000000000000000000000000000005"
    map[27] = "40000000000000000000000000000000000000000000000005"
    map[28] = "40001111111111111100000000011111111111111111100005"
    map[29] = "40000000000000000000000000000000000000000000000005"
    map[30] = "40000000000000000000000000000000000000000000000005"
    map[31] = "40000000000000000000000000000000000000000000000005"
    map[32] = "40000000000000000000000000000000000000000000000005"
    map[33] = "40000000000000000000000000000000000000000000000005"
    map[34] = "40000000000000000000000000000000000000000000000005"
    map[35] = "40000000000000000000000000000000000000000000000005"
    map[36] = "40000000000000000000000000000000000000000000000005"
    map[37] = "11111111111111111111111111111111111111111111111111"
  end
end

function InitGame(pNiveau)
  lstSprites = {}
  ChargeNiveau(pNiveau)
end

function CreateSprite(pType, pX, pY)
  local mySprite = {}

  mySprite.x = pX
  mySprite.y = pY
  mySprite.vx = 0
  mySprite.vy = 0
  mySprite.frame = 0
  mySprite.type = pType
  mySprite.standing = false

  table.insert(lstSprites, mySprite)

  return mySprite
end

-- fonction très utile qui reçoit une position en pixel et retourne le caractères de la map se trouvant à cette position
function getTileAt(pX, pY)
  local col = math.floor(pX / 16) + 1
  local lig = math.floor(pY / 16) + 1
  if col > 0 and col <= #map[1] and lig > 0 and lig <= #map then
    local id = string.sub(map[lig], col, col)
    return id
  end
  return 0
end

function love.load()
  love.window.setMode(800, 600)

  width = love.graphics.getWidth()
  height = love.graphics.getHeight()
  print("Screen size is " .. width .. "," .. height)
  love.window.setTitle("Mini platformer (c) Gamecodeur 2017")
  InitGame(1)
end

function love.update(dt)
end

function love.draw()
  for l = 1, #map do
    for c = 1, #map[1] do
      local char = string.sub(map[l], c, c)
      if char ~= "0" then
        love.graphics.draw(imgTiles[char], (c - 1) * 16, (l - 1) * 16)
      end
    end
  end

  local id = getTileAt(love.mouse.getX(), love.mouse.getY())
  love.graphics.print(id)
end

function love.keypressed(key)
  print(key)
end
